# Packaging and deploying K8S applications using Helm #

## Pre-Requisites ##

You should have successfully set up your environment as outlined in [Day1](../bootcamp/day1/README.md)

## Deploying the Todo List Application ##

From within the helm directory run the following command:

```
#do a dry run install to make sure everything is ok
helm install --dry-run todo-app

#install the todo-app
helm install todo-app

#check that the app has been deployed.  You should see the todo-app has been deployed.
helm ls
```

Open a browser and access the application.

## Deploying istio ##

From within the helm directory run the following command which will download the latest version of the istio chart archive.

```
helm fetch incubator/istio --devel
```

Unarchive the chart archive e.g. istio-x.x.x-chart.tgz and you will see an 'istio' directory.  This is the helm chart for istio.

To deploy the chart.   

```
helm install istio --set rbacEnabled=false
```

Note, you may need to update the istio.release value int the istio/value.yml file.  The release number must correspond to the latest tag value of the docker images [here](https://hub.docker.com/r/istio/grafana/tags/) 

Helm will deploy the chart to K8S then state the release was deployed but that CustomResourceDefinitions were required to be installed prior to installing the services.  CustomResourceDefinitions have been deployed, you need upgrade the service to run the services.  Run the following command, replacing <release_name> with the name istio provides.

```
helm upgrade <release_name> incubator/istio --reuse-values --set istio.install=true
```

This will take a few minutes, run ```kubectl get deployments``` to see how the deployment is progressing.

Once everything has deployed, run the following commands to access the Grafana dashboard.

```
#uses jsonpath query to extract the pod name generated by K8S and exports to an environement variable
export POD_NAME=$(kubectl get pods --namespace default -l "component=istio-grafana" -o jsonpath="{.items[0].metadata.name}")

#opens a proxy to the pod so you can access it via localhost
kubectl port-forward $POD_NAME 3000:3000 --namespace default
```

Open a browser and access the Grafana dashboard at [http://127.0.0.1:3000/dashboard/db/istio-dashboard](http://127.0.0.1:3000/dashboard/db/istio-dashboard)

You have just deployed a complex system to K8S using helm charts!!

For more details about istio see the [README](./istio/README.md) in the istio directory.

## References ##

- [Helm Documenation](https://docs.helm.sh/using_helm/) 
